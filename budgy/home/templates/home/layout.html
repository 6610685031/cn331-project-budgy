<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="keywords" content="manage, money, profit" />
    <meta name="description" content="Manage Your Finances" />
    <title>'BUDGY' -
      {% block title %}
      {% endblock title %}
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600&display=swap"
          rel="stylesheet">
    {% load static %}
    <link href="{% static 'home/style.css' %}" rel="stylesheet">
    <style>
      /* small safety: ensure pet is on top and transitions for resize if used */
      #pet { transition: width 0.18s ease, height 0.18s ease, transform 0.18s ease; touch-action: none; }
      #pet-talk { pointer-events: none; }
    </style>
  </head>
  <body   
  data-page="{{ request.resolver_match.url_name|default:'' }}"
  data-user-id="{{ request.user.id }}">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="#">üí∞ BUDGY</a>
        <button class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarContent">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>
    
    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å Django messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-warning{% endif %} text-center">
          <strong>{{ message }}</strong>
        </div>
      {% endfor %}
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block body %}
    {% endblock body %}

    {# ---------------- Desktop Pet: ‡πÉ‡∏™‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏¥‡∏î body ---------------- #}
    {% if user.is_authenticated and user.profile.show_mascot %}
      <img id="pet" alt="pet"
          src=""
          style="opacity:0; position:fixed; left:40px; top:calc(100% - 280px); width:360px; height:430px; z-index:2147483646; user-select:none; touch-action:none; cursor:grab;"
          ondragstart="return false;">
      <div id="pet-talk"
          style="position:fixed; padding:8px 12px; background:rgba(255,255,255,0.95); border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.12); display:none; z-index:2147483645; max-width:260px;">
      </div>

      <!-- script ‡∏ô‡πâ‡∏≠‡∏á mascot ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° -->
      <script>
      (async function () {
        const EDGE_MARGIN = 10;
        const POLL_INTERVAL_MS = 60000;
        let LONGPRESS_MS = 120;
        const MOVE_THRESHOLD = 5;

        const petEl = document.getElementById("pet");
        const talkEl = document.getElementById("pet-talk");
        if (!petEl) return;

        /* ---------- CONFIG: sprite paths ---------- */
        const STATIC = {
          idle:     "{% static 'home/pet/idle.png' %}?v=2",
          falling:  "{% static 'home/pet/falling.png' %}?v=2",
          picked:   "{% static 'home/pet/picked.png' %}?v=2",
          teaching: "{% static 'home/pet/teaching.png' %}?v=2",
          happy:    "{% static 'home/pet/happy.png' %}?v=2",
          danger:   "{% static 'home/pet/danger.png' %}?v=2",
          waving:   "{% static 'home/pet/waving.png' %}?v=2"
        };

        function testImage(src) {
          return new Promise(res => {
            if (!src) return res(false);
            const i = new Image();
            i.onload = () => res(true);
            i.onerror = () => res(false);
            i.src = src;
          });
        }

        function emojiDataURL(e) {
          const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'>
            <text x='50%' y='50%' font-size='120' dominant-baseline='middle' text-anchor='middle'>${e}</text>
          </svg>`;
          return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        async function resolveImages() {
          const idleOK   = await testImage(STATIC.idle);
          const idleSrc  = idleOK ? STATIC.idle   : emojiDataURL('üê±');
          const falling  = (await testImage(STATIC.falling )) ? STATIC.falling  : idleSrc;
          const picked   = (await testImage(STATIC.picked  )) ? STATIC.picked   : idleSrc;
          const teaching = (await testImage(STATIC.teaching)) ? STATIC.teaching : idleSrc;
          const happy    = (await testImage(STATIC.happy   )) ? STATIC.happy    : idleSrc;
          const danger   = (await testImage(STATIC.danger  )) ? STATIC.danger   : idleSrc;
          const waving   = (await testImage(STATIC.waving)) ? STATIC.waving : happySrc;
          
          return { idleSrc: idleSrc, fallingSrc: falling, pickedSrc: picked,
                  teachingSrc: teaching, happySrc: happy, dangerSrc: danger,  wavingSrc: waving  };
        }

        const { idleSrc, fallingSrc, pickedSrc, teachingSrc, happySrc, dangerSrc, wavingSrc } =
          await resolveImages();

        /* ---------- first load: choose initial image, avoid flicker ---------- */
        const userId = document.body.dataset.userId || "guest";
        const SESSION_KEY = `pet_session_seen_user_${userId}`;
        const isFreshSession = !sessionStorage.getItem(SESSION_KEY);

        async function setInitialImageAndShow() {
          const chosen = isFreshSession ? happySrc : idleSrc;

          await new Promise(res => {
            const img = new Image();
            let to = setTimeout(res, 300); // safety timeout
            img.onload  = () => { clearTimeout(to); res(); };
            img.onerror = () => { clearTimeout(to); res(); };
            img.src = chosen;
          });

          petEl.src = chosen;
          requestAnimationFrame(() => { petEl.style.opacity = 1; });
        }

        await new Promise(res => setTimeout(res, 30)); // ‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏î layout ‡πÑ‡∏î‡πâ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏à‡∏£‡∏¥‡∏á
        await setInitialImageAndShow();

        /* ---------- small helpers ---------- */
        function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }

        function showChat(text, ttl = 3500) {
          if (!talkEl) return;
          talkEl.textContent = text;
          talkEl.style.display = "block";
          clearTimeout(talkEl._t);
          talkEl._t = setTimeout(() => { talkEl.style.display = "none"; }, ttl);
        }

        /* ---------- finance mood lines ---------- */
        const moodLines = {
          happy: ["‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏µ‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢! ‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÅ‡∏ó‡∏ô‡∏ô‡∏∞! üòä","‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏î‡∏î~ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!","‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ ‡πÄ‡∏£‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏≤‡∏¢! ‚ú®"],
          neutral: ["‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÇ‡∏≠‡πÄ‡∏Ñ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞~","‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏î‡∏π‡∏õ‡∏Å‡∏ï‡∏¥‡∏î‡∏µ‡πÄ‡∏ô‡∏≤‡∏∞ üòä","‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏±‡πâ‡∏¢‡∏•‡πà‡∏∞?"],
          warn: ["‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞ ‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÑ‡∏õ‡∏ô‡∏¥‡∏î‚Ä¶ üò•","‡πÄ‡∏£‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πà‡∏∞!","‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏´‡∏ô‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á‡∏°‡∏±‡πâ‡∏¢?"],
          danger: ["‡πÇ‡∏≠‡πâ‡∏¢‡∏¢‚Ä¶ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ô‡∏∞‡∏à‡∏£‡∏¥‡∏á ‡πÜ! ‚ö†Ô∏è","‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‚Ä¶ ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢!","‡πÄ‡∏£‡∏≤‡∏´‡πà‡∏ß‡∏á‡∏ô‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞ ‡∏•‡∏≠‡∏á‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏≠‡∏∞ üò≠"]
        };
        function getRandomStatusLine(status){ const arr=moodLines[status]||[]; return arr.length?arr[Math.floor(Math.random()*arr.length)]:null; }

        // ‡∏´‡∏ô‡πâ‡∏≤ ‡∏û‡∏¥‡πÄ‡∏®‡∏ó‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£
        const PAGE_TEACHING = {
          // ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
          transaction_income: [
            "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏© üí∞\n1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà\n2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö\n3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤\n4. ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°"
          ],
          // ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
          transaction_expense: [
            "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≤‡∏á ‡πÜ üßæ\n1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà\n2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢\n3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡πÄ‡∏á‡∏¥‡∏ô\n4. ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"
          ],
          // ‡πÇ‡∏≠‡∏ô‡πÑ‡∏õ‡∏°‡∏≤
          transaction_transfer: [
            "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏Å Wallet ‡πÑ‡∏õ Bank üè¶\n1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà\n2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á\n3. ‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô\n4. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ö‡∏ß‡∏Å‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á"
          ],
          // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà ‡∏Ø‡∏•‡∏Ø)
          account_management: [
            "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢ üí≥\n‚Ä¢ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏á‡∏¥‡∏ô)\n‚Ä¢ ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0)\n*‡∏ö‡∏±‡∏ç‡∏ä‡∏µ 'Cash' ‡∏°‡∏±‡∏Å‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏ô‡∏∞*"
          ],
          dashboard: [
            "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Dashboard üìä\n‚Ä¢ ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n‚Ä¢ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠\n‚Ä¢ ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß ‡πÜ\n\n‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏∞~ üòâ"
          ],
          // Stats
          stats: [
            "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ Stats üìà\n‚Ä¢ ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢\n‚Ä¢ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î\n‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏õ‡∏µ\n\n‡∏Å‡∏£‡∏≤‡∏ü‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡∏≤‡∏¢‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÑ‡∏´‡∏ô üëÄ"
          ],
          // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå / ‡∏≠‡∏µ‡πÄ‡∏°‡∏• / ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô / logout
          settings: [
            "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ Settings ‚öôÔ∏è\n‚Ä¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå\n‚Ä¢ ‡πÅ‡∏Å‡πâ Username\n‚Ä¢ ‡πÅ‡∏Å‡πâ Email\n‚Ä¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô\n‚Ä¢ ‡∏•‡∏ö Account\n‚Ä¢ ‡πÅ‡∏•‡∏∞ Logout ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢"
          ]
        };

        // helper ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ (‡∏°‡∏≤‡∏à‡∏≤‡∏Å data-page ‡∏ö‡∏ô <body>)
        function getPageName() {
          return (document.body.dataset.page || "").trim();
        }


        function randomFrom(arr) {
          if (!arr || !arr.length) return null;
          return arr[Math.floor(Math.random() * arr.length)];
        }

        function moodToSprite(status) {
          if (status === "happy")  return happySrc;
          if (status === "danger") return dangerSrc;
          // neutral ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏ä‡πâ idle ‡πÑ‡∏õ
          return idleSrc;
        }

        /* ---------- save / restore position (with falling info) ---------- */
        let progressiveSaveTimer = null;

        function savePos(meta = {}) {
          try {
            const r = petEl.getBoundingClientRect();
            const left = Math.round(r.left);
            const top  = Math.round(r.top);
            const payload = Object.assign({ left, top }, meta);
            localStorage.setItem('pet_state', JSON.stringify(payload));
          } catch (e) {
            console.warn("savePos failed", e);
          }
        }

        function stopProgressiveSave() {
          if (progressiveSaveTimer) {
            clearInterval(progressiveSaveTimer);
            progressiveSaveTimer = null;
          }
        }

        function startProgressiveSaveWithVel(getVelFn) {
          stopProgressiveSave();
          progressiveSaveTimer = setInterval(() => {
            try {
              const r = petEl.getBoundingClientRect();
              const left = Math.round(r.left);
              const top  = Math.round(r.top);
              const vel  = typeof getVelFn === "function" ? Math.max(0, Math.round(getVelFn())) : 0;
              localStorage.setItem('pet_state', JSON.stringify({ left, top, falling: true, vel }));
            } catch (e) { /* ignore */ }
          }, 120);
        }

        /* ---------- initial / resume drop with physics ---------- */
        let initialDropRAF = null;

        function startInitialDrop(targetTop, initialVel = 0, opts = {}) {
          if (initialDropRAF) {
            cancelAnimationFrame(initialDropRAF);
            initialDropRAF = null;
          }
          stopProgressiveSave();

          const h = petEl.clientHeight || 120;
          const floor = window.innerHeight - h - EDGE_MARGIN;
          const desiredTop = (typeof targetTop === "number" && !Number.isNaN(targetTop))
            ? clamp(targetTop, EDGE_MARGIN, floor)
            : floor;

          // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡πà‡∏≤‡∏ï‡∏Å
          petEl.src = fallingSrc;

          if (!opts.resume) {
            petEl.style.top = "-160px";
            petEl.style.bottom = "auto";
          } else {
            petEl.style.top = Math.round(desiredTop) + "px";
          }

          let vel = Number(initialVel) || 0;
          const GRAVITY = 2200;
          const TERMINAL = 3000;
          let lastT = performance.now();

          startProgressiveSaveWithVel(() => vel);

          function step(now) {
            const dt = Math.max(0.001, (now - lastT) / 1000);
            lastT = now;

            vel += GRAVITY * dt;
            if (vel > TERMINAL) vel = TERMINAL;

            const r = petEl.getBoundingClientRect();
            let newTop = r.top + vel * dt;

            if (newTop >= desiredTop) {
              newTop = desiredTop;
              petEl.style.top = Math.round(newTop) + "px";

              // ‡πÄ‡∏î‡πâ‡∏á‡∏î‡∏∂‡πã‡∏á‡∏ï‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô
              const impactNorm = Math.min(1, vel / 1600);
              const squash = Math.min(0.16, impactNorm * 0.12);
              petEl.style.transition = "transform 160ms cubic-bezier(.2,.8,.2,1)";
              petEl.style.transform  = `scaleY(${1 - squash}) scaleX(${1 + squash/2})`;
              setTimeout(() => {
                petEl.style.transform = "";
                petEl.style.transition = "";
              }, 220);

              stopProgressiveSave();
              savePos({ falling: false, vel: 0 });
              petEl.src = idleSrc;

              initialDropRAF = null;
              return;
            } else {
              petEl.style.top = Math.round(newTop) + "px";
            }

            initialDropRAF = requestAnimationFrame(step);
          }

          initialDropRAF = requestAnimationFrame(step);
        }

        // restore / resume
        (function restore() {
          try {
            const s = JSON.parse(localStorage.getItem("pet_state") || "{}");
            const w = petEl.clientWidth || 120;
            const h = petEl.clientHeight || 120;
            const floor = window.innerHeight - h - EDGE_MARGIN;
            const hasSaved = (typeof s.left === "number" && typeof s.top === "number");

            if (hasSaved) {
              const left = clamp(s.left, EDGE_MARGIN,
                Math.max(EDGE_MARGIN, window.innerWidth - w - EDGE_MARGIN));
              petEl.style.left = left + "px";

              if (s.falling) {
                const resumeTop = clamp(s.top, EDGE_MARGIN, floor);
                petEl.style.top = resumeTop + "px";
                petEl.style.bottom = "auto";
                const initialVel = typeof s.vel === "number" ? s.vel : 0;
                startInitialDrop(floor, initialVel, { resume: true });
              } else {
                const top = clamp(s.top, EDGE_MARGIN, floor);
                petEl.style.top = top + "px";
                petEl.style.bottom = "auto";
              }
              savePos({ falling: !!s.falling, vel: s.vel || 0 });
            } else {
              // ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‚Üí ‡∏ï‡∏Å‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
              const defaultLeft = 40;
              petEl.style.left = defaultLeft + "px";
              const floor = window.innerHeight - (petEl.clientHeight || 120) - EDGE_MARGIN;
              startInitialDrop(floor, 0, { resume: false });
            }
          } catch (e) {
            console.warn("restore error", e);
          }
        })();

        /* ---------- simple gravity after drag / carry ---------- */
        let gravityTimer = null;
        function applyGravity() {
          if (gravityTimer) clearInterval(gravityTimer);

          petEl.src = fallingSrc;

          gravityTimer = setInterval(() => {
            const r = petEl.getBoundingClientRect();
            const h = petEl.clientHeight;
            let newTop = r.top + 10;
            const floor = window.innerHeight - h - EDGE_MARGIN;

            if (newTop >= floor) {
              newTop = floor;
              clearInterval(gravityTimer);
              gravityTimer = null;

              petEl.style.top = Math.round(newTop) + "px";
              petEl.style.bottom = "auto";

              // ‡πÄ‡∏î‡πâ‡∏á‡∏ï‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô
              petEl.style.transition = "transform 160ms cubic-bezier(.2,.8,.2,1)";
              petEl.style.transform  = "scaleY(0.88) scaleX(1.06)";
              setTimeout(() => {
                petEl.style.transform = "";
                petEl.style.transition = "";
              }, 220);

              savePos();
              petEl.src = idleSrc;
              return;
            }

            petEl.style.top = Math.round(newTop) + "px";
            petEl.style.bottom = "auto";
          }, 16);
        }

        /* ---------- API: ‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô mood ---------- */
        async function fetchFinanceStatus(showBubble = false) {
          try {
            const res = await fetch("{% url 'pet_status_api' %}", {
              headers: { Accept: "application/json" }
            });
            if (!res.ok) throw new Error("network");
            const j = await res.json();

            if (showBubble) {
              showChat(`‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${j.total_balance}‡∏ø ‚Äî ${j.advice}`, 5000);
            }

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ debug / ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ
            window._pet_finance = j;
            return j;   // j.status ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ happy / neutral / danger
          } catch (e) {
            console.warn("fetchFinanceStatus error", e);
            return null;
          }
        }


        // poll background (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡πá‡∏•‡∏ö‡∏™‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ)
        fetchFinanceStatus(false);
        setInterval(() => fetchFinanceStatus(false), POLL_INTERVAL_MS);

        /* ---------- drag / pick state ---------- */
        let dragging = false, isCarried = false;
        let downAt = 0, offset = { x: 0, y: 0 };
        let longPressTimer = null, longPressFired = false;
        let lastPointer = { x: 0, y: 0 };

        function startCarry() {
          isCarried = true;
          petEl.src = pickedSrc;
        }
        function endCarry() {
          if (!isCarried) return;
          isCarried = false;
          petEl.src = idleSrc;
          savePos();
        }

        function startLongPress() {
          clearLongPress();
          longPressFired = false;
          longPressTimer = setTimeout(() => {
            longPressFired = true;
            startCarry();
          }, LONGPRESS_MS);
        }
        function clearLongPress() {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        }

        /* ---------- pointer handlers ---------- */
        petEl.addEventListener("pointerdown", e => {
          e.preventDefault();
          try { petEl.setPointerCapture(e.pointerId); } catch {}

          downAt = performance.now();
          const r = petEl.getBoundingClientRect();
          offset.x = e.clientX - r.left;
          offset.y = e.clientY - r.top;
          lastPointer.x = e.clientX;
          lastPointer.y = e.clientY;

          startLongPress();
        });

        petEl.addEventListener('pointermove', e=>{
          if(!downAt) return;
          const dx = Math.abs(e.clientX - lastPointer.x);
          const dy = Math.abs(e.clientY - lastPointer.y);

          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° ‚Äú‡∏•‡∏≤‡∏Å‚Äù ‡πÅ‡∏•‡πâ‡∏ß
          if(dx > MOVE_THRESHOLD || dy > MOVE_THRESHOLD){
            clearLongPress();

            const w = petEl.clientWidth, h = petEl.clientHeight;
            let left = e.clientX - offset.x;
            let top  = e.clientY - offset.y;
            left = clamp(left, EDGE_MARGIN, Math.max(EDGE_MARGIN, window.innerWidth - w - EDGE_MARGIN));
            top  = clamp(top,  EDGE_MARGIN, Math.max(EDGE_MARGIN, window.innerHeight - h - EDGE_MARGIN));
            petEl.style.left = left+'px';
            petEl.style.top  = top+'px';
            petEl.style.bottom='auto';

            if(!dragging){
              dragging = true;
              petEl.src = pickedSrc;      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å -> ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ picked
              petEl.style.cursor = 'grabbing';
            }
            return;
          }

          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏≤‡∏Å ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î long-press ‡∏´‡∏¥‡πâ‡∏ß‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
          if(longPressFired){
            const w = petEl.clientWidth, h = petEl.clientHeight;
            let left = e.clientX - w/2;
            let top  = e.clientY - h/2;
            left = clamp(left, EDGE_MARGIN, Math.max(EDGE_MARGIN, window.innerWidth - w - EDGE_MARGIN));
            top  = clamp(top, EDGE_MARGIN, Math.max(EDGE_MARGIN, window.innerHeight - h - EDGE_MARGIN));
            petEl.style.left = left+'px';
            petEl.style.top  = top+'px';
            petEl.style.bottom='auto';
          }
        });

        petEl.addEventListener("pointerup", async e => {
          try { petEl.releasePointerCapture(e.pointerId); } catch {}
          clearLongPress();

          // ----- long press = pickup mode -----
          if (longPressFired) {
            longPressFired = false;
            endCarry();
            savePos();
            applyGravity();
            downAt = 0;
            return;
          }

          // ----- dragging = ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å -----
          if (dragging) {
            dragging = false;
            petEl.style.cursor = "grab";
            savePos();
            applyGravity();
            downAt = 0;
            return;
          }

          // ---------- quick tap behaviour ----------
          const path = (window.location.pathname || "").toLowerCase();

          const isTransactionPage =
            path.includes("transaction");  // income / expense / transfer
          const isAccountsPage =
            path.includes("account") || path.includes("accounts_management");
          const isSettingsPage =
            path.includes("settings");
          const isStats =
            path.includes("stats");
          const isDashboard =
            path.includes("dashboard");

          // ---------- MODE 1: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (transaction + accounts + settings) ----------
          if (isTransactionPage || isAccountsPage || isSettingsPage) {
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ teachingSrc ‡∏Å‡πá‡πÉ‡∏ä‡πâ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô fallback ‡πÄ‡∏õ‡πá‡∏ô idle
            if (typeof teachingSrc !== "undefined" && teachingSrc) {
              petEl.src = teachingSrc;
            } else {
              petEl.src = idleSrc;
            }

            let lines;

            if (isTransactionPage) {
              // --- ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° Transaction ---
              if (path.includes("income")) {
                // ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
                lines = [
                  "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ô‡∏∞ ‡∏•‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢~",
                  "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢ ‡πÜ ‡∏ô‡∏∞!"
                ];
              } else if (path.includes("expense")) {
                // ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
                lines = [
                  "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üßæ\n‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏ô‡πâ‡∏≤~",
                  "‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏µ ‡πÜ ‡∏•‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏´‡∏°‡∏ß‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î!"
                ];
              } else if (path.includes("transfer")) {
                // ‡πÇ‡∏≠‡∏ô
                lines = [
                  "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏Å Cash ‡πÑ‡∏õ Bank üè¶",
                  "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‚Äì‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡πá‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢~"
                ];
              } else {
                // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤ transaction ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
                lines = [
                  "‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏∞ ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢~",
                  "‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏á‡∏á ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏±‡∏ô‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡πà‡∏∞!"
                ];
              }

            } else if (isAccountsPage) {
              // --- ‡∏´‡∏ô‡πâ‡∏≤ accounts_management ---
              lines = [
                "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢ üí≥\n‡∏î‡∏π‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢!",
                "‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô Bank ‡∏´‡∏£‡∏∑‡∏≠ Wallet ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞~",
              ];

            } else if (isSettingsPage) {
              // --- ‡∏´‡∏ô‡πâ‡∏≤ settings ---
              lines = [
                "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ Settings ‚öôÔ∏è\n‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå, Username, Email ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢!",
                "‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Logout) ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Å‡πá‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ô‡∏∞ ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏•‡πà‡∏∞ üí•",
              ];
            } else if (isStats) {
              // --- ‡∏´‡∏ô‡πâ‡∏≤ settings ---
              lines = [
                "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ Stats üìä\n‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤",
                "‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞ ‚ú®",
              ];
            } else if (isDashboard) {
              // --- ‡∏´‡∏ô‡πâ‡∏≤ settings ---
              lines = [
                "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ Dashboard üè†\n‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ô‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
                "‡∏î‡∏π‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏•‡∏¢ üòä",
              ];
            }else {
              // ‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á‡πÄ‡∏â‡∏¢ ‡πÜ (‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
              lines = [
                "‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÄ‡∏°‡∏ô‡∏π/‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á ‡πÜ ‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢~"
              ];
            }

            const line = randomFrom(lines);
            if (line) showChat(line, 5500);   // ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏à‡∏≠‡∏ô‡∏≤‡∏ô‡∏´‡∏ô‡πà‡∏≠‡∏¢

            // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ idle ‡∏´‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î‡∏à‡∏ö
            setTimeout(() => {
              if (!isCarried) petEl.src = idleSrc;
            }, 4000);

          } else {
          // ---------- MODE 2: ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÜ = ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ----------
          const j = await fetchFinanceStatus(true); // bubble summary ‡∏î‡πâ‡∏ß‡∏¢

          if (j && j.status) {
            const sprite = moodToSprite(j.status);
            petEl.src = sprite;

            const line = randomFrom(moodLines[j.status] || []);
            if (line) showChat(line, 3500);

            setTimeout(() => {
              if (!isCarried) petEl.src = idleSrc;
            }, 3500);
          } else {
            // ‡∏ñ‡πâ‡∏≤ API ‡∏û‡∏±‡∏á ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° fallback ‡∏õ‡∏Å‡∏ï‡∏¥
            const fallback = await (async () => {
              try {
                const res = await fetch("{% url 'pet_chat_api' %}", {
                  headers: { Accept: "application/json" }
                });
                if (!res.ok) throw 0;
                const j2 = await res.json();
                return j2.text;
              } catch {
                return randomFrom(["‡∏Æ‡∏±‡∏•‡πÇ‡∏´‡∏•~", "‡∏û‡∏±‡∏Å‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞", "‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤"]);
              }
            })();
            showChat(fallback, 3000);
            }
          }

          downAt = 0;
        });

        petEl.addEventListener("dblclick", () => {
          // no-op ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î double-click ‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ
        });

        /* ---------- bubble follow ---------- */
        function updateBubble() {
          if (!talkEl || talkEl.style.display === "none") return;
          const talkW = 260;
          const r = petEl.getBoundingClientRect();
          const bubbleH = talkEl.offsetHeight || 40;

          let top  = r.top - bubbleH - 12;
          let left = r.left + (r.width / 2) - (talkW / 2);

          left = clamp(left, 8, Math.max(8, window.innerWidth - talkW - 8));
          if (top < 8) top = r.bottom + 12;

          talkEl.style.left = Math.round(left) + "px";
          talkEl.style.top  = Math.round(top) + "px";
          talkEl.style.bottom = "auto";
        }
        (function rafLoop() {
          function loop() {
            updateBubble();
            requestAnimationFrame(loop);
          }
          requestAnimationFrame(loop);
        })();

        function ensureVisible() {
          try {
            const r = petEl.getBoundingClientRect();
            const w = petEl.clientWidth, h = petEl.clientHeight;
            let left = r.left, top = r.top;
            const maxLeft = Math.max(EDGE_MARGIN, window.innerWidth - w - EDGE_MARGIN);
            const maxTop  = Math.max(EDGE_MARGIN, window.innerHeight - h - EDGE_MARGIN);
            let changed = false;

            if (left < EDGE_MARGIN) { left = EDGE_MARGIN; changed = true; }
            if (top  < EDGE_MARGIN) { top  = EDGE_MARGIN; changed = true; }
            if (left > maxLeft)     { left = maxLeft;     changed = true; }
            if (top  > maxTop)      { top  = maxTop;      changed = true; }

            if (changed) {
              petEl.style.left = Math.round(left) + "px";
              petEl.style.top  = Math.round(top) + "px";
              petEl.style.bottom = "auto";
              savePos();
            }
          } catch (e) {}
        }
        window.addEventListener("resize",            () => setTimeout(ensureVisible, 60));
        window.addEventListener("orientationchange", () => setTimeout(ensureVisible, 60));

        // debug hook
        window._pet_debug = window._pet_debug || {};
        Object.assign(window._pet_debug, { fetchFinanceStatus, ensureVisible, savePos });

        /* ---------- greeting first time in tab ---------- */
        if (isFreshSession) {
          try {
            await new Promise(r => setTimeout(r, 400));

            // üëã ‡πÉ‡∏ä‡πâ waving ‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡∏Å
            petEl.src = wavingSrc;

            const greetings = [
              "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ô‡∏∞! üêæ",
              "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏à‡∏±‡∏á‡πÄ‡∏•‡∏¢‡∏ô‡πâ‡∏≤~ üíõ",
              "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡πÜ ‡∏ô‡∏∞!",
              "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏≤‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏á‡∏ö‡∏°‡∏±‡πâ‡∏¢~?",
              "‡∏ñ‡πâ‡∏≤‡∏á‡πà‡∏ß‡∏á‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏ô‡∏∞ ‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏≠‡∏Å üò¥",
              "‡∏´‡∏ß‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ô‡∏∞! ‚ú®"
            ];

            const count = Math.floor(Math.random() * 2) + 2;
            const pick  = greetings.sort(() => Math.random() - 0.5).slice(0, count);

            for (let i = 0; i < pick.length; i++) {
              showChat(pick[i], 3000);
              await new Promise(r => setTimeout(r, 3500));
            }

            await fetchFinanceStatus(true);

            // ‚úÖ ‡∏à‡∏≥‡∏ß‡πà‡∏≤ user ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            sessionStorage.setItem(SESSION_KEY, "1");

            // üîÑ ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà idle / happy ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡∏Å
            setTimeout(() => {
              if (!isCarried) petEl.src = idleSrc;
            }, 300);

          } catch (e) {}
        }

      })();
      </script>
    {% endif %}
    {# ---------------- end Desktop Pet ---------------- #}

  </body>
</html>

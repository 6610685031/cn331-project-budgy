{% extends "home/layout.html" %}
{% block title %}
    Dashboard
{% endblock title %}
{% block body %}
    <style>
    body {
      font-family: "Chakra Petch", sans-serif;
      background: #f4fcff;
      min-height: 100vh;
    }

    .box {
      background: white;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 3px 14px rgba(0,0,0,0.08);
    }

    .spending-box { height: 350px; }

    #spending-list, #spending-list th, #spending-list td {
    border: none; /* ‡∏ï‡∏±‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    padding: 6px 8px;
    }

    #spending-list th, #spending-list td {
        text-align: left; /* ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
    }
    </style>
    <!-- Dashboard Layout -->
    <div class="container py-5">
        <div class="row g-4">
            <!-- Center: Current Spending -->
            <div class="col-lg-8">
                <div class="box spending-box">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Current Spending</h4>
                        <!-- View Mode Toggle -->
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary active" id="btn-daily">Daily</button>
                            <button class="btn btn-outline-primary" id="btn-monthly">Monthly</button>
                            <button class="btn btn-outline-primary" id="btn-yearly">Yearly</button>
                        </div>
                    </div>
                    <!-- Date Selectors -->
                    <div class="mb-3" id="date-selectors">
                        <input type="date"
                               id="daily-picker"
                               class="form-control"
                               style="max-width: 220px">
                        <input type="month"
                               id="monthly-picker"
                               class="form-control d-none"
                               style="max-width: 220px">
                        <input type="number"
                               id="yearly-picker"
                               class="form-control d-none"
                               style="max-width: 220px"
                               placeholder="Enter Year (e.g., 2025)"
                               min="2000"
                               max="2100">
                    </div>
                    <!-- Spending List -->
                    <table id="spending-list" style="width:100%; border-collapse: collapse; table-layout: fixed;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Category</th>
                                <th style="text-align: left;">Income (‡∏ø)</th>
                                <th style="text-align: left;">Expense (‡∏ø)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" style="text-align:center; color: #888;">Select a date to view spending...</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th style="text-align: left;">Total</th>
                                <th id="total-income" style="text-align: left;">0</th>
                                <th id="total-expense" style="text-align: left;">0</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <!-- Right Column -->
            <div class="col-lg-4 d-flex flex-column gap-4">
                <!-- Top-right: Transaction Rate -->
                <div class="box">
                    <h5>Transaction Rate</h5>
                    <p>Example: 12 transactions / week</p>
                </div>
                <!-- Bottom-right: Account Balance -->
                <div class="box">
                    <h5>Accounts</h5>
                    <div id="account-box">
                        <p class="text-muted">Loading accounts...</p>
                    </div>
                    <hr>
                    <h5>Total Balance</h5>
                    <h2 id="total-balance" style="color:#0077b6;">‡∏ø 0.00</h2>
                </div>
            </div>
        </div>
    </div>
    <script>
        // function renderList(spendings, mode) {
        //   const list = document.getElementById("spending-list");
        //   list.innerHTML = "";
        
        //   if (spendings.length === 0) {
        //     list.innerHTML = `<li class="list-group-item text-center text-muted">No records found.</li>`;
        //     return;
        //   }
      
        //   spendings.forEach(item => {
        //     let label = mode === "daily" ? item.time : item.date;
        //     list.innerHTML += `
        //       <li class="list-group-item d-flex justify-content-between">
        //         <span>${item.category || "Uncategorized"}</span>
        //         <strong>‡∏ø ${item.amount}</strong>
        //       </li>`;
        //   });
        // }
        
        function renderList(spendings) {
            const tbody = document.querySelector("#spending-list tbody");
            tbody.innerHTML = "";

            let totalIncome = 0;
            let totalExpense = 0;

            if (spendings.length === 0) {
                tbody.innerHTML = `<tr><td class="text-center text-muted" colspan="3">No records found.</td></tr>`;
            } else {
                spendings.forEach(item => {
                    let income = item.type === "income" ? item.amount.toFixed(2) : "";
                    let expense = item.type === "expense" ? item.amount.toFixed(2) : "";

                    if (item.type === "income") totalIncome += item.amount;
                    if (item.type === "expense") totalExpense += item.amount;

                    tbody.innerHTML += `
                        <tr>
                            <td>${item.category || "Uncategorized"}</td>
                            <td>${income}</td>
                            <td>${expense}</td>
                        </tr>
                    `;
                });
            }

            document.getElementById("total-income").textContent = totalIncome.toFixed(2);
            document.getElementById("total-expense").textContent = totalExpense.toFixed(2);
        }
        async function fetchSpending(mode, value) {
            const params = new URLSearchParams({ mode: mode });

            if (mode === "daily") params.append("date", value);   // YYYY-MM-DD
            if (mode === "monthly") params.append("month", value); // YYYY-MM
            if (mode === "yearly") params.append("year", value);   // YYYY

            const response = await fetch(`/api/spending/?${params.toString()}`);
            const data = await response.json();

            renderList(data.spendings); // render ‡πÅ‡∏ö‡∏ö Income / Expense
        }

            // üü¢ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ 3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        async function fetchAccounts() {
            const response = await fetch("/api/accounts/");
            const data = await response.json();

            const box = document.querySelector("#account-box");
            box.innerHTML = "";

            if (data.accounts.length === 0) {
                box.innerHTML = `<p class="text-muted">No accounts found.</p>`;
            } else {
                data.accounts.forEach(acc => {
                box.innerHTML += `<p>${acc.name}: <strong>‡∏ø ${acc.balance.toFixed(2)}</strong></p>`;
                });
            }

            // total balance
            document.getElementById("total-balance").textContent = `‡∏ø ${data.total_balance.toFixed(2)}`;
            }

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
            document.addEventListener("DOMContentLoaded", fetchAccounts);

            // Event listeners ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            document.getElementById("btn-daily").onclick = () => setMode("daily");
            document.getElementById("btn-monthly").onclick = () => setMode("monthly");
            document.getElementById("btn-yearly").onclick = () => setMode("yearly");
            document.getElementById("daily-picker").onchange = (e) => fetchSpending("daily", e.target.value);
            document.getElementById("monthly-picker").onchange = (e) => fetchSpending("monthly", e.target.value);
            document.getElementById("yearly-picker").onchange = (e) => fetchSpending("yearly", e.target.value);

        // Mode switching
        function setMode(mode) {
          document.getElementById("daily-picker").classList.toggle("d-none", mode !== "daily");
          document.getElementById("monthly-picker").classList.toggle("d-none", mode !== "monthly");
          document.getElementById("yearly-picker").classList.toggle("d-none", mode !== "yearly");
        
          ["btn-daily","btn-monthly","btn-yearly"].forEach(id =>
            document.getElementById(id).classList.remove("active")
          );
          document.getElementById(`btn-${mode}`).classList.add("active");
        }
        
        document.getElementById("btn-daily").onclick = () => setMode("daily");
        document.getElementById("btn-monthly").onclick = () => setMode("monthly");
        document.getElementById("btn-yearly").onclick = () => setMode("yearly");

        // Daily
        document.getElementById("daily-picker").onchange = (e) => fetchSpending("daily", e.target.value);

        // Monthly (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö input[type=month] ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM)
        document.getElementById("monthly-picker").onchange = (e) => fetchSpending("monthly", e.target.value);

        // Yearly (input[type=number])
        document.getElementById("yearly-picker").onchange = (e) => fetchSpending("yearly", e.target.value);
            </script>
{% endblock body %}
